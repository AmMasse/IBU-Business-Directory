<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IBU Business Directory - Register Your Business</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 700px;
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="40" r="1" fill="white" opacity="0.1"/><circle cx="40" cy="80" r="1.5" fill="white" opacity="0.1"/></svg>');
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    .content {
      padding: 40px;
    }

    .welcome-page, .step {
      display: none;
      animation: fadeIn 0.5s ease-in;
    }

    .welcome-page.active, .step.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .welcome-content {
      text-align: center;
      color: #333;
    }

    .welcome-content h2 {
      color: #4facfe;
      font-size: 2rem;
      margin-bottom: 20px;
    }

    .welcome-content p {
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 20px;
      color: #666;
    }

    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .feature {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      transform: translateY(0);
      transition: transform 0.3s ease;
    }

    .feature:hover {
      transform: translateY(-5px);
    }

    .feature-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .data-protection {
      background: #f8f9fa;
      border-left: 4px solid #4facfe;
      padding: 20px;
      margin: 30px 0;
      border-radius: 10px;
    }

    .data-protection h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .data-protection ul {
      color: #666;
      padding-left: 20px;
      line-height: 1.6;
    }

    .consent-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin: 20px 0;
      padding: 15px;
      background: #fff;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }

    .consent-checkbox input[type="checkbox"] {
      margin-top: 4px;
      transform: scale(1.2);
    }

    .consent-checkbox label {
      color: #333;
      line-height: 1.5;
      cursor: pointer;
    }

    .step h3 {
      color: #4facfe;
      font-size: 1.5rem;
      margin-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 5px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
      transform: translateY(-2px);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 8px;
      transition: background 0.3s ease;
    }

    .checkbox-item:hover {
      background: #e9ecef;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 30px;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .progress-bar {
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e9ecef;
      transition: all 0.3s ease;
    }

    .step-dot.active {
      background: #4facfe;
      transform: scale(1.2);
    }

    .step-dot.completed {
      background: #28a745;
    }

    /* Auth Modal Styles */
    #auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .auth-container {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
    }

    .auth-container h2 {
      margin-bottom: 1rem;
      color: #4facfe;
    }

    .auth-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .auth-button {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
    }

    #auth-error {
      color: #f5576c;
      margin-top: 1rem;
      display: none;
    }

    /* User Info Styles */
    #user-info {
      display: none;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 10px;
      margin-bottom: 20px;
      align-items: center;
      justify-content: space-between;
    }

    #user-info p {
      margin: 0;
      font-weight: 600;
    }

    #user-info span {
      color: #4facfe;
    }

    #sign-out-button {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .content {
        padding: 20px;
      }

      .features {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .auth-container {
        padding: 1.5rem;
        margin: 0 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div id="auth-modal">
    <div class="auth-container">
      <h2>Sign In / Register</h2>
      
      <div id="auth-email">
        <div class="form-group">
          <label for="auth-email-input">Email Address</label>
          <input type="email" id="auth-email-input" class="auth-input" placeholder="your@email.com">
        </div>
        <button id="auth-email-button" class="auth-button">
          Continue with Email
        </button>
      </div>
      
      <div id="auth-otp" style="display: none;">
        <p style="margin-bottom: 1rem;">We've sent a magic link to your email. Please check your inbox.</p>
        <p style="margin-bottom: 1rem;">Alternatively, enter the OTP here:</p>
        <div class="form-group">
          <label for="auth-otp-input">OTP Code</label>
          <input type="text" id="auth-otp-input" class="auth-input" placeholder="6-digit code">
        </div>
        <button id="auth-verify-button" class="auth-button">
          Verify OTP
        </button>
      </div>
      
      <div id="auth-error"></div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <h1>Mr. IBU Business Directory</h1>
      <p>Join our growing community of local businesses</p>
    </div>

    <div class="content">
      <!-- User Info (shown after auth) -->
      <div id="user-info">
        <p>Logged in as: <span id="user-email"></span></p>
        <button id="sign-out-button">Sign Out</button>
      </div>

      <!-- Welcome Page -->
      <div class="welcome-page active" id="welcome">
        <div class="welcome-content">
          <h2>Welcome to Our Business Directory Platform</h2>
          <p>We're building a comprehensive directory to help local businesses connect with their community and grow their reach. By registering your business with us, you're taking the first step toward increased visibility and customer engagement.</p>

          <div class="features">
            <div class="feature">
              <div class="feature-icon">🌟</div>
              <h4>Increased Visibility</h4>
              <p>Get discovered by potential customers in your area</p>
            </div>
            <div class="feature">
              <div class="feature-icon">📱</div>
              <h4>Mobile Friendly</h4>
              <p>Your business profile works perfectly on all devices</p>
            </div>
            <div class="feature">
              <div class="feature-icon">🔍</div>
              <h4>Easy to Find</h4>
              <p>Customers can search by location, category, and services</p>
            </div>
          </div>

          <div class="data-protection">
            <h3>Data Protection & Usage Agreement</h3>
            <p><strong>We respect your privacy and are committed to protecting your data.</strong></p>
            <ul>
              <li>Your business information will be displayed publicly in our directory</li>
              <li>We follow industry-standard data protection practices</li>
              <li>You can request updates or removal of your information at any time</li>
              <li>We will never sell your personal contact information to third parties</li>
              <li>Your data helps customers find and connect with your business</li>
            </ul>
          </div>

          <div class="consent-checkbox">
            <input type="checkbox" id="consent" required>
            <label for="consent">
              <strong>I understand and agree</strong> that the business information I provide will be made publicly available in the online directory to help customers find my business. I confirm that I have the authority to provide this information and consent to its public display.
            </label>
          </div>

          <div class="button-group">
            <button class="btn btn-primary" id="start-registration" disabled>
              Start Registration
            </button>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-bar" id="progress-container" style="display: none;">
        <div class="progress-fill" id="progress-fill"></div>
      </div>

      <!-- Step Indicators -->
      <div class="step-indicator" id="step-indicators" style="display: none;">
        <div class="step-dot active"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
      </div>

      <form id="business-form">
        <!-- Step 1: Business Information -->
        <div class="step" id="step1">
          <h3>Step 1: Business Information</h3>
          <div class="form-group">
            <label for="business_name">Business Name *</label>
            <input type="text" id="business_name" name="business_name" placeholder="Enter your business name" required>
          </div>
          <div class="form-group">
            <label for="owner_name">Owner/Manager Name</label>
            <input type="text" id="owner_name" name="owner_name" placeholder="Your name">
          </div>
          <div class="form-group">
            <label for="category">Business Category *</label>
            <select id="category" name="category" required>
              <option value="">Select a category</option>
              <option value="Health">Health & Medical</option>
              <option value="Beauty">Beauty & Wellness</option>
              <option value="Food">Food & Restaurants</option>
              <option value="Construction">Construction & Building</option>
              <option value="Education">Education & Training</option>
              <option value="Transport">Transportation</option>
              <option value="Retail">Retail & Shopping</option>
              <option value="Technology">Technology & IT</option>
              <option value="Finance">Finance & Banking</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="services">Services Offered</label>
            <input type="text" id="services" name="services" placeholder="e.g., Web design, Catering, Repairs (comma-separated)">
          </div>
          <div class="form-group">
            <label for="business_description">Business Description</label>
            <textarea id="business_description" name="business_description" placeholder="Tell customers about your business, what makes you special..."></textarea>
          </div>
          <div class="form-group">
            <label for="tags">Keywords/Tags</label>
            <input type="text" id="tags" name="tags" placeholder="e.g., local food, affordable, punctual, etc (comma-separated)">
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-primary" onclick="nextStep()">Next Step →</button>
          </div>
        </div>

        <!-- Step 2: Contact & Location -->
        <div class="step" id="step2">
          <h3>Step 2: Contact & Location</h3>
          <div class="form-group">
            <label for="contact_phone">Phone Number</label>
            <input type="tel" id="contact_phone" name="contact_phone" placeholder="+256 XXX XXX XXX">
          </div>
          <div class="form-group">
            <label for="contact_email">Email Address</label>
            <input type="email" id="contact_email" name="contact_email" placeholder="business@example.com">
          </div>
          <div class="form-group">
            <label for="whatsapp">WhatsApp Number</label>
            <input type="tel" id="whatsapp" name="whatsapp" placeholder="+256 XXX XXX XXX">
          </div>
          <div class="form-group">
            <label for="region">Region</label>
            <input type="text" id="region" name="region" placeholder="e.g., Central, Northern, Eastern, Western">
          </div>
          <div class="form-group">
            <label for="district">District</label>
            <input type="text" id="district" name="district" placeholder="District name">
          </div>
          <div class="form-group">
            <label for="subcounty">Sub-county</label>
            <input type="text" id="subcounty" name="subcounty" placeholder="Sub-county name">
          </div>
          <div class="form-group">
            <label for="parish">Parish</label>
            <input type="text" id="parish" name="parish" placeholder="Parish name">
          </div>
          <div class="form-group">
            <label for="village">Village/Area</label>
            <input type="text" id="village" name="village" placeholder="Village or area name">
          </div>
          <div class="form-group">
            <label for="trading_centre">Trading Centre/Zone</label>
            <input type="text" id="trading_centre" name="trading_centre" placeholder="Trading centre or zone">
          </div>
          <div class="form-group">
            <label for="landmark">Landmark (Optional)</label>
            <input type="text" id="landmark" name="landmark" placeholder="Near which landmark?">
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep()">← Back</button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">Next Step →</button>
          </div>
        </div>

        <!-- Step 3: Business Details -->
        <div class="step" id="step3">
          <h3>Step 3: Business Details</h3>
          <div class="form-group">
            <label for="price_range">Price Range</label>
            <input type="text" id="price_range" name="price_range" placeholder="e.g., 10,000 - 50,000 UGX">
          </div>
          <div class="form-group">
            <label for="website">Website</label>
            <input type="url" id="website" name="website" placeholder="https://yourwebsite.com">
          </div>
          <div class="form-group">
            <label for="latitude">Latitude (GPS)</label>
            <input type="number" step="any" id="latitude" name="latitude" placeholder="0.347596">
          </div>
          <div class="form-group">
            <label for="longitude">Longitude (GPS)</label>
            <input type="number" step="any" id="longitude" name="longitude" placeholder="32.582520">
          </div>
          <div class="form-group">
            <label for="working_hours">Working Hours</label>
            <input type="text" id="working_hours" name="working_hours" placeholder="8:00 AM - 6:00 PM">
          </div>
          <div class="form-group">
            <label for="payment_methods">Payment Methods</label>
            <input type="text" id="payment_methods" name="payment_methods" placeholder="Cash, Mobile Money, Card (comma-separated)">
          </div>
          <div class="form-group">
            <label for="languages">Languages Spoken</label>
            <input type="text" id="languages" name="languages" placeholder="English, Luganda, Swahili (comma-separated)">
          </div>
          <div class="form-group">
            <label for="logo_url">Logo URL (Optional)</label>
            <input type="url" id="logo_url" name="logo_url" placeholder="https://example.com/logo.png">
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep()">← Back</button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">Next Step →</button>
          </div>
        </div>

        <!-- Step 4: Working Days -->
        <div class="step" id="step4">
          <h3>Step 4: Working Days</h3>
          <div class="form-group">
            <label>Select your working days:</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="monday" name="working_days" value="Monday">
                <label for="monday">Monday</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tuesday" name="working_days" value="Tuesday">
                <label for="tuesday">Tuesday</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="wednesday" name="working_days" value="Wednesday">
                <label for="wednesday">Wednesday</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="thursday" name="working_days" value="Thursday">
                <label for="thursday">Thursday</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="friday" name="working_days" value="Friday">
                <label for="friday">Friday</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="saturday" name="working_days" value="Saturday">
                <label for="saturday">Saturday</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="sunday" name="working_days" value="Sunday">
                <label for="sunday">Sunday</label>
              </div>
            </div>
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep()">← Back</button>
            <button type="submit" class="btn btn-primary">Submit Registration</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Initialize Supabase client
    const supabaseUrl = 'https://qbcrtnbxrdpkxmlbdlkn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiY3J0bmJ4cmRwa3htbGJkbGtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNjA4NjUsImV4cCI6MjA2NTYzNjg2NX0.KbInVmeJ1AZzLXdKe4pGxKMsMX_54KgXcz5HiZOEtxg';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Auth state management
    let authUser = null;

    // DOM elements
    const authModal = document.getElementById('auth-modal');
    const authEmailSection = document.getElementById('auth-email');
    const authOtpSection = document.getElementById('auth-otp');
    const authError = document.getElementById('auth-error');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const signOutButton = document.getElementById('sign-out-button');
    const welcomePage = document.getElementById('welcome');
    const startButton = document.getElementById('start-registration');
    const consentCheckbox = document.getElementById('consent');

    // Form steps management
    let currentStep = 0;
    const steps = document.querySelectorAll(".step");
    const stepDots = document.querySelectorAll(".step-dot");
    const progressFill = document.getElementById("progress-fill");
    const progressContainer = document.getElementById("progress-container");
    const stepIndicators = document.getElementById("step-indicators");

    // Check auth state on page load
    document.addEventListener('DOMContentLoaded', checkAuth);

    // Auth functions
    async function checkAuth() {
      const { data, error } = await supabase.auth.getSession();
      
      if (data.session) {
        authUser = data.session.user;
        showUserInfo();
        // Enable the registration form if user is authenticated
        startButton.disabled = !consentCheckbox.checked;
      } else {
        showAuthModal();
      }
    }

    function showUserInfo() {
      userEmail.textContent = authUser.email;
      userInfo.style.display = 'flex';
    }

    function showAuthModal() {
      authModal.style.display = 'flex';
      startButton.disabled = true;
    }

    function hideAuthModal() {
      authModal.style.display = 'none';
    }

    function showError(message) {
      authError.textContent = message;
      authError.style.display = 'block';
      setTimeout(() => {
        authError.style.display = 'none';
      }, 5000);
    }

    // Email auth handler
    document.getElementById('auth-email-button').addEventListener('click', async () => {
      const email = document.getElementById('auth-email-input').value.trim();
      
      if (!email) {
        showError('Please enter your email');
        return;
      }
      
      const { data, error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: window.location.href
        }
      });
      
      if (error) {
        showError(error.message);
      } else {
        authEmailSection.style.display = 'none';
        authOtpSection.style.display = 'block';
        document.getElementById('auth-otp-input').focus();
      }
    });

    // OTP verification handler
    document.getElementById('auth-verify-button').addEventListener('click', async () => {
      const token = document.getElementById('auth-otp-input').value.trim();
      const email = document.getElementById('auth-email-input').value.trim();
      
      if (!token) {
        showError('Please enter the OTP code');
        return;
      }
      
      const { data, error } = await supabase.auth.verifyOtp({
        email,
        token,
        type: 'email'
      });
      
      if (error) {
        showError(error.message);
      } else {
        authUser = data.user;
        hideAuthModal();
        showUserInfo();
        // Enable the registration form
        startButton.disabled = !consentCheckbox.checked;
      }
    });

    // Sign out handler
    signOutButton.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (!error) {
        authUser = null;
        userInfo.style.display = 'none';
        showAuthModal();
        // Reset the form
        startButton.disabled = true;
      }
    });

    // Consent checkbox handler
    consentCheckbox.addEventListener('change', function() {
      if (authUser) {
        startButton.disabled = !this.checked;
      }
    });

    // Start registration button handler
    startButton.addEventListener('click', function() {
      if (consentCheckbox.checked && authUser) {
        welcomePage.classList.remove("active");
        progressContainer.style.display = "block";
        stepIndicators.style.display = "flex";
        showStep(0);
      }
    });

    // Form step functions
    function showStep(step) {
      steps.forEach((el, idx) => el.classList.toggle("active", idx === step));
      
      // Update step indicators
      stepDots.forEach((dot, idx) => {
        dot.classList.remove("active", "completed");
        if (idx < step) dot.classList.add("completed");
        if (idx === step) dot.classList.add("active");
      });

      // Update progress bar
      const progress = ((step + 1) / steps.length) * 100;
      progressFill.style.width = progress + "%";
    }

    function nextStep() {
      // Validate current step before proceeding
      if (currentStep === 0) {
        const businessName = document.getElementById("business_name");
        const category = document.getElementById("category");
        
        if (!businessName.value) {
          businessName.focus();
          showError('Please enter your business name');
          return;
        }
        
        if (!category.value) {
          category.focus();
          showError('Please select a business category');
          return;
        }
      }
      
      if (currentStep < steps.length - 1) {
        currentStep++;
        showStep(currentStep);
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    }

    // Form submission
    document.getElementById("business-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      // Check if user is authenticated
      if (!authUser) {
        showError('Please sign in to submit your business');
        showAuthModal();
        return;
      }
      
      // Show loading state
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = "Submitting...";
      submitBtn.disabled = true;

      try {
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        // Add user info to the business data
        data.user_id = authUser.id;
        data.user_email = authUser.email;

        // Collect all working days checked
        data.working_days = Array.from(formData.getAll("working_days")).join(',');

        // Convert list fields to arrays
        if (data.services) data.services = data.services.split(',').map(s => s.trim()).filter(s => s);
        if (data.tags) data.tags = data.tags.split(',').map(t => t.trim()).filter(t => t);
        if (data.payment_methods) data.payment_methods = data.payment_methods.split(',').map(p => p.trim()).filter(p => p);
        if (data.languages) data.languages = data.languages.split(',').map(l => l.trim()).filter(l => l);

        console.log("Submitting data:", data);

        const response = await fetch("https://qbcrtnbxrdpkxmlbdlkn.supabase.co/rest/v1/businesses", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": supabaseKey,
            "Authorization": `Bearer ${supabaseKey}`,
            "Prefer": "return=representation"
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          // Success animation
          submitBtn.textContent = "✅ Success!";
          submitBtn.style.background = "#28a745";
          
          setTimeout(() => {
            alert("🎉 Business registration submitted successfully!\n\nThank you for joining our directory. Your business will be reviewed and published soon.");
            this.reset();
            currentStep = 0;
            welcomePage.classList.add("active");
            progressContainer.style.display = "none";
            stepIndicators.style.display = "none";
            steps.forEach(step => step.classList.remove("active"));
            consentCheckbox.checked = false;
            startButton.disabled = true;
          }, 1500);
        } else {
          const error = await response.json();
          throw new Error(JSON.stringify(error));
        }
      } catch (error) {
        console.error("Submission error:", error);
        showError('Submission failed. Please check your internet connection and try again.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = "";
      }
    });

    // Add some interactive elements
    document.addEventListener("DOMContentLoaded", function() {
      // Add floating animation to features
      const features = document.querySelectorAll(".feature");
      features.forEach((feature, index) => {
        feature.style.animationDelay = (index * 0.2) + "s";
      });
    });
  </script>
</body>
</html>
